import{a as c}from"./chunk-IXTZP2PS.js";import{a as j}from"./chunk-JHOHYJWD.js";import{a as O}from"./chunk-BIOTDHRQ.js";import{a as K}from"./chunk-V4S4ILHZ.js";import{a as n}from"./chunk-MIQK74YD.js";import{a as M}from"./chunk-XELMOVSA.js";import{a as G}from"./chunk-HMNUYURD.js";import{a as R}from"./chunk-N2PVEWVS.js";import{O as P,_ as U,aa as $,da as F,ea as N,fa as H,va as I}from"./chunk-MMBMDBOW.js";import"./chunk-CARY4E7O.js";import"./chunk-4KKA7PE6.js";import{Ab as b,Fa as x,Ib as y,N as s,Ob as L,Tb as C,Ub as D,Vc as E,Zb as w,ac as A,cc as l,ea as g,ka as o,n as m,o as h,oa as _,tb as d,u,v as a,vc as k,wc as T,y as f,ya as S,za as v}from"./chunk-VO6IE2C5.js";var p=(()=>{class i{constructor(){this._networkService=o(F),this._updateLogs$=new h([]),this.updateLogs$=this._updateLogs$.asObservable()}getAllLogs(t){this._networkService.post(n.UPDATE_LOGS.byUser,t).pipe(s(1)).subscribe({next:e=>{e&&e.data&&this._updateLogs$.next(e.data)}})}getAllSearchLogs(t){this._networkService.post(n.UPDATE_LOGS.search,t).pipe(s(1)).subscribe({next:e=>{e&&e.data&&this._updateLogs$.next(e.data)}})}deleteLogs(t){this._networkService.delete(n.UPDATE_LOGS.logs,void 0,t._id).pipe(s(1)).subscribe({next:()=>{this._updateLogs(t,"delete")}})}deleteSelectedLogs(t){this._networkService.delete(n.UPDATE_LOGS.selectedLogs,{ids:t.map(e=>e._id)}).pipe(s(1)).subscribe({next:()=>{this._updateLogs(t,"delete")}})}_updateLogs(t,e){j.UpdateArrayBehaviorSubject(this._updateLogs$,t,e,"_id")}static{this.\u0275fac=function(e){return new(e||i)}}static{this.\u0275prov=g({token:i,factory:i.\u0275fac})}}return i})();function B(i,q){if(i&1){let t=w();C(0,"ks-basic-grid",1),A("selectionChange",function(r){S(t);let V=l();return v(V.selectionChange(r))}),D()}if(i&2){let t=l();y("config",t.gridConfig)("refresh$",t.refresh$)}}var ue=(()=>{class i{constructor(){this._destroyRef=o(x),this._navService=o(R),this._dialog=o($),this._storageService=o(N),this._snackbar=o(H),this._updateLogsService=o(p),this._lovService=o(K),this._data=[],this._currentScreen=M("update_logs_listing"),this._showDeleteAll=d(!1),this._selectedLogs=[],this._isAdmin=this._storageService.getItem(G.SS.user,!0)?.roles.includes("system_administrator"),this.refresh$=new m}ngOnInit(){this._navService.updateNav({show:!0,back:!1,title:this._currentScreen.screenName,buttons:[{label:{text:"Delete Selected"},prefixIcon:{icon:"icon_delete_filled"},show:E(()=>this._currentScreen.delete&&this._showDeleteAll()),onClick:()=>{this._deleteSelectedLogs()}},{label:{text:"Advance Search"},prefixIcon:{icon:"icon_search"},hide:!this._currentScreen.search,onClick:()=>{this._openSearch()}}]}),this._lovService.getMenusAndServicesLov(),this._updateLogsService.getAllLogs({fromDate:c("start"),toDate:c("end")}),this._initializeGrid(),this._updateLogsService.updateLogs$.pipe(P(this._destroyRef)).subscribe(t=>{this._data=t,this.refresh$.next({data:this._data})})}selectionChange(t){this._showDeleteAll.set(!!t.length),this._selectedLogs=t}_initializeGrid(){this.gridConfig={multiSelect:this._currentScreen.delete,data:d([]),defaultPagination:150,maxTableHeight:O.maxTableHeightWithSearch,noDataMessage:{text:"No logs Found"},features:{showSearch:!0},elevation:2,columns:[{field:"email",title:"Email",type:"string"},{field:"name",title:"Name",type:"string",extraStyles:{"min-width":"120px","max-width":"120px"}},{field:"createdAt",title:"Time",type:"date",dateFormat:"dd/MM/yyyy - HH:mm:ss a",extraStyles:{"min-width":"180px"}},{field:"serviceName",title:"Service",type:"string",extraStyles:{"min-width":"150px"}},{field:"deviceType",title:"Device Type",type:"string",extraStyles:{"min-width":"110px"},hide:!this._isAdmin},{field:"ip",title:"ip",type:"string",extraStyles:{"min-width":"110px"},hide:!this._isAdmin},{field:"userAgent",title:"User Agent",type:"string",hide:!this._isAdmin,extraStyles:{"min-width":"400px","max-width":"400px"}}],actionsColumn:{enabled:this._currentScreen.delete,maxButtons:window.innerWidth<700?1:void 0,maxWidth:window.innerWidth<700?void 0:"110px",minWidth:window.innerWidth<700?void 0:"110px",buttons:[{prefixIcon:{icon:"icon_delete",color:"red"},label:{text:"Delete"},onClickFn:t=>this._deleteLog(t),isVisibleFn:()=>this._currentScreen.delete,matType:"mat-icon-button"}]}}}_openSearch(){if(!this._currentScreen.search)return;let t={title:{text:"Logs Search"},saveButton:{prefixIcon:{icon:"icon_search"},label:{text:"Search"},matType:"mat-stroked-button"},form:{fields:[{name:"fromDate",label:{text:"From Date"},type:"date",required:!0,formatTime:"start",range:{max:"toDate"}},{name:"toDate",label:{text:"To Date"},type:"date",range:{min:"fromDate"},required:!0,formatTime:"end"},{name:"services",label:{text:"Services And Menus"},type:"select",multiple:!0,stream:this._lovService.menusAndServicesLov$.pipe(f(e=>e.filter(r=>r.type==="menu"||r.type==="service"&&r.viewLogs))),transformer:{nameKey:"name",valueKey:"_id"},required:!0}]},beforeCloseObservable:e=>e.fromDate&&e.toDate&&!U.isValidDateRange(366,e.fromDate,e.toDate)?(this._snackbar.open({text:"Maximum allowed date gap is 1 year."},"error"),a(()=>"")):e.fromHour!==void 0&&e.toHour!==void 0&&e.fromHour>=e.toHour?(this._snackbar.open({text:"From hour should be smaller than to hour."},"error"),a(()=>"")):u(e)};this._dialog.openFormPopup(t,"800px").afterClosed().pipe(s(1)).subscribe(e=>{e&&this._updateLogsService.getAllSearchLogs({fromDate:e.fromDate,toDate:e.toDate,services:e.services?typeof e.services=="string"?[e.services]:e.services:[]})})}_deleteLog(t){let e={title:{text:"Confirm Delete"},message:{text:"Are you sure you want to delete this log?"}};this._dialog.openConfirmPopup(e).afterClosed().pipe(s(1)).subscribe(r=>{r&&t&&t._id&&this._updateLogsService.deleteLogs(t)})}_deleteSelectedLogs(){let t={title:{text:"Confirm Delete"},message:{text:"Are you sure you want to delete all selected logs?"}};this._dialog.openConfirmPopup(t).afterClosed().pipe(s(1)).subscribe(e=>{e&&this._updateLogsService.deleteSelectedLogs(this._selectedLogs)})}static{this.\u0275fac=function(e){return new(e||i)}}static{this.\u0275cmp=_({type:i,selectors:[["ks-solutions-update-logs-listing"]],standalone:!0,features:[k([p]),T],decls:1,vars:1,consts:[[3,"config","refresh$"],[3,"selectionChange","config","refresh$"]],template:function(e,r){e&1&&b(0,B,1,2,"ks-basic-grid",0),e&2&&L(r.gridConfig?0:-1)},dependencies:[I],changeDetection:0})}}return i})();export{ue as UpdateLogsComponent};
