import{a as _}from"./chunk-VMV3LQCJ.js";import{a as Y}from"./chunk-AOWBTXPG.js";import{D as j,E as s,K as O,M as B,_ as M,ba as J,ga as K,ka as z,la as G,ra as Q}from"./chunk-6OZBD6B5.js";import"./chunk-CARY4E7O.js";import"./chunk-F5WOQGUX.js";import{$b as F,Fa as q,Hb as c,N as d,Nb as P,Sb as o,Tb as r,Ub as l,Yb as g,a as E,b as D,bc as f,db as N,ea as I,hb as a,ka as u,mc as m,n as U,nc as $,o as T,oa as R,sb as y,uc as L,vc as V,wc as p,xc as S,ya as h,yc as w,za as C,zb as k}from"./chunk-RQMRH3XI.js";var A=(()=>{class t{constructor(){this._networkService=u(J),this.user=new T(null)}changePassword(e,i){return this._networkService.post(_.USER.changePassword,{newPassword:e,oldPassword:i})}enable2Fa(){return this._networkService.post(_.USER.enable2FA,{})}disable2Fa(e){return this._networkService.post(_.USER.disable2FA,{token:e})}verify2Fa(e){return this._networkService.post(_.USER.verify2FA,{token:e})}getLoggedInUser(){this._networkService.get(_.USER.loggedInUser).pipe(d(1)).subscribe(e=>{e?.data&&this.user.next(e.data)})}static{this.\u0275fac=function(i){return new(i||t)}}static{this.\u0275prov=I({token:t,factory:t.\u0275fac})}}return t})();var te=()=>({text:"Email"}),x=(t,b)=>({control:t,label:b,readonly:!0}),ie=()=>({text:"Name"}),ne=()=>({text:"Role"}),oe=()=>({text:"Joined At"}),re=()=>({text:"Disable 2FA"}),ae=t=>({label:t,color:"warn",matType:"mat-flat-button",addClass:"rounded-2"}),se=()=>({text:"Verify & Activate"}),ce=t=>({label:t,matType:"mat-flat-button",addClass:"rounded-2"}),le=()=>({text:"Enable 2FA"}),de=t=>({label:t,addClass:"rounded-2",matType:"mat-flat-button"});function me(t,b){if(t&1){let e=g();o(0,"p",12),m(1,"\u2705 2FA is enabled"),r(),o(2,"ks-base-button",13),F("onClick",function(){h(e);let n=f();return C(n.disable2FA())}),r()}t&2&&(a(2),c("config",S(2,ae,p(1,re))))}function pe(t,b){if(t&1){let e=g();o(0,"div",15)(1,"p"),m(2,"Scan the QR code with your favorite Authenticator App:"),r(),l(3,"img",16),o(4,"div",15)(5,"ks-base-button",13),F("onClick",function(){h(e);let n=f(2);return C(n.verify2FA())}),r()()()}if(t&2){let e=f(2);a(3),c("src",e.qrCode(),N),a(2),c("config",S(3,ce,p(2,se)))}}function ue(t,b){if(t&1){let e=g();o(0,"ks-base-button",13),F("onClick",function(){h(e);let n=f(2);return C(n.enable2FA())}),r()}t&2&&c("config",S(2,de,p(1,le)))}function fe(t,b){if(t&1&&(o(0,"p",14),m(1,"\u26A0\uFE0F 2FA is not enabled"),r(),k(2,pe,6,5,"div",15)(3,ue,1,4,"ks-base-button",5)),t&2){let e=f();a(2),P(e.qrCode()?2:3)}}var De=(()=>{class t{constructor(){this._destroyRef=u(q),this._dialog=u(M),this._profileService=u(A),this._navService=u(Y),this.error=y(""),this.qrCode=y(""),this.userForm=new j({_id:new s(""),name:new s(""),role:new s(""),email:new s(""),password:new s(""),passwordRetries:new s(""),active:new s(""),isDeleted:new s(""),twoFactorEnabled:new s(""),isOAuthUser:new s(""),createdAt:new s(""),suspended:new s("")}),this.saveConfig={label:{text:"Save"},prefixIcon:{icon:"icon_save"},matType:"mat-flat-button",onClick:()=>{this.action$.next("save")},id:"save"},this.action$=new U,this.formConfig={fields:[{label:{text:"Old Password"},type:"password",name:"oldPassword",required:!0},{label:{text:"new Password"},type:"password",name:"newPassword",required:!0,extraValidators:[K({forceLowerCase:!0,forceNumbers:!0,forceSpecialCharacters:!0,forceUppercase:!0,maxLength:20,minLength:4,preventSpace:!0})]},{label:{text:"Confirm Password"},type:"password",name:"confirmPassword",required:!0}],onSave:e=>{console.log(e),e&&e.newPassword&&e.newPassword&&(e.newPassword!==e.confirmPassword?this.error.set("Confirm password does not match the new password!"):this._profileService.changePassword(e.newPassword,e.oldPassword).pipe(d(1)).subscribe(i=>{i&&(this.action$.next("clear"),this.error.set(""))}))}}}ngOnInit(){this._profileService.getLoggedInUser(),this._profileService.user.pipe(B(this._destroyRef)).subscribe(e=>{if(e){let i=v=>{let H=new Intl.DateTimeFormat("en-US",{weekday:"long"}).format(v),W=v.getDate(),X=new Intl.DateTimeFormat("en-US",{month:"long"}).format(v),Z=v.getFullYear();return`${H} ${W} ${X} ${Z}`},n=new Date(e.createdAt);this.userForm.patchValue(D(E({},e),{createdAt:i(n)}))}}),this._navService.updateNav({title:"Profile",show:!1,back:!1})}enable2FA(){this._profileService.enable2Fa().pipe(d(1)).subscribe(e=>{e.data&&this.qrCode.set(e.data)})}disable2FA(){let e={title:{text:"Disable 2FA"},form:{fields:[{label:{text:"Authenticator Code"},type:"number",name:"token",required:!0}]}};this._dialog.openFormPopup(e,"500px").afterClosed().pipe(d(1)).subscribe(i=>{i?.token&&this._profileService.disable2Fa(JSON.stringify(i.token)).pipe(d(1)).subscribe(n=>{n&&this._profileService.getLoggedInUser()})})}verify2FA(){let e={title:{text:"Verify 2FA"},form:{fields:[{label:{text:"Authenticator Code"},type:"number",name:"token",required:!0}]}};this._dialog.openFormPopup(e,"500px").afterClosed().pipe(d(1)).subscribe(i=>{i?.token&&this._profileService.verify2Fa(JSON.stringify(i.token)).pipe(d(1)).subscribe(n=>{n&&this._profileService.getLoggedInUser()})})}static{this.\u0275fac=function(i){return new(i||t)}}static{this.\u0275cmp=R({type:t,selectors:[["ks-solutions-profile"]],standalone:!0,features:[L([A]),V],decls:29,vars:25,consts:[[1,"container-fluid"],[1,"card","p-4","shadow"],[1,"mb-4"],[1,"row"],[1,"col-md-6"],[3,"config"],[1,"col-md-6","mt-3"],[1,"my-4"],[1,"text-center"],[1,"mx-auto",2,"max-width","490px"],[3,"config","action$"],[1,"text-danger","mb-3","small"],[1,"text-success","fw-bold"],[3,"onClick","config"],[1,"text-warning"],[1,"mt-3"],["alt","qrCode",1,"img-fluid",3,"src"]],template:function(i,n){i&1&&(o(0,"div",0)(1,"div",1)(2,"h2",2),m(3,"Profile"),r(),o(4,"div",3)(5,"div",4),l(6,"ks-base-input",5),r(),o(7,"div",4),l(8,"ks-base-input",5),r(),o(9,"div",6),l(10,"ks-base-input",5),r(),o(11,"div",6),l(12,"ks-base-input",5),r()(),l(13,"hr",7),o(14,"div",8)(15,"h4"),m(16,"Two-Factor Authentication (2FA)"),r(),o(17,"div"),k(18,me,3,4)(19,fe,4,1),r()(),l(20,"hr",7),o(21,"div",8)(22,"h4"),m(23,"Change Password"),r(),o(24,"div",9),l(25,"ks-dynamic-form",10),o(26,"div",11),m(27),r(),l(28,"ks-base-button",5),r()()()()),i&2&&(a(6),c("config",w(10,x,n.userForm.controls.email,p(9,te))),a(2),c("config",w(14,x,n.userForm.controls.name,p(13,ie))),a(2),c("config",w(18,x,n.userForm.controls.role,p(17,ne))),a(2),c("config",w(22,x,n.userForm.controls.createdAt,p(21,oe))),a(6),P(n.userForm.controls.twoFactorEnabled.value?18:19),a(7),c("config",n.formConfig)("action$",n.action$),a(2),$(n.error()),a(),c("config",n.saveConfig))},dependencies:[O,z,G,Q],styles:[".cs-card[_ngcontent-%COMP%]{transition:transform .3s}"],changeDetection:0})}}return t})();export{De as ProfileComponent};
