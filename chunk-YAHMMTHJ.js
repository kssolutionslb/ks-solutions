import{a as N}from"./chunk-ACRHOBEB.js";import"./chunk-5XQMOD5G.js";import"./chunk-64QL26MT.js";import{a as R}from"./chunk-5BWCYXSX.js";import{a as T}from"./chunk-O3DFJTSE.js";import"./chunk-ACYZVNWI.js";import{a as r}from"./chunk-GR3MB6LF.js";import{a as A}from"./chunk-GQ637NOE.js";import"./chunk-HMNUYURD.js";import{a as E}from"./chunk-72TK6UK2.js";import{O as w,aa as U,da as F,ha as k,va as P}from"./chunk-XXZS4MWG.js";import"./chunk-CARY4E7O.js";import"./chunk-4KKA7PE6.js";import{Ab as x,Fa as f,Ib as _,N as o,Ob as S,Vb as b,a,b as c,cc as v,ea as m,ka as n,n as l,oa as h,tb as g,vc as y,wc as C,y as u,z as d}from"./chunk-VO6IE2C5.js";var p=(()=>{class s{constructor(){this._socketService=n(N),this._networkService=n(F),this._users$=new l,this.users$=d([this._socketService.onlineUsers$,this._users$]).pipe(u(([e,t])=>t.map(i=>c(a({},i),{online:!!i._id&&e.includes(i._id)}))))}getAllUsers(){this._networkService.get(r.USERS.listing).subscribe({next:e=>{this._users$.next(e.data?e.data:[])}})}addNewUser(e){return this._networkService.post(r.USERS.listing,e)}editUser(e){return this._networkService.patch(r.USERS.listing,e,e._id)}sendMessageToUserUser(e,t){return this._networkService.post(r.USERS.message,{userId:e._id,payload:t})}forceLogoutUser(e){this._networkService.post(r.USERS.forceLogout,{userId:e._id}).pipe(o(1)).subscribe()}toggleUserSuspension(e,t){return this._networkService.patch(r.USERS.suspend,e,t?"true":"false")}activateUser(e){this._networkService.patch(r.USERS.activate,e).pipe(o(1)).subscribe({next:()=>{this.getAllUsers()}})}changeUserPassword(e){return this._networkService.patch(r.USERS.changePassword,e)}remove2FaForUser(e){this._networkService.patch(r.USERS.remove_2fa,e).pipe(o(1)).subscribe({next:()=>{this.getAllUsers()}})}deleteUser(e){this._networkService.delete(r.USERS.listing,void 0,e._id).pipe(o(1)).subscribe({next:()=>{this.getAllUsers()}})}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=m({token:s,factory:s.\u0275fac})}}return s})();function L(s,D){if(s&1&&b(0,"ks-basic-grid",0),s&2){let e=v();_("config",e.gridConfig)("refresh$",e.refresh$)}}var ie=(()=>{class s{constructor(){this._dialog=n(U),this._destroyRef=n(f),this._userService=n(p),this._navService=n(E),this._lovService=n(T),this._currentScreen=A("users_listing"),this.refresh$=new l}ngOnInit(){this._navService.updateNav({show:!0,back:!1,title:this._currentScreen.screenName,buttons:[{label:{text:"Create New"},prefixIcon:{icon:"icon_plus_circle"},hide:!this._currentScreen.insert,onClick:()=>{this._openUserPopup()}}]}),this._lovService.getRolesLov(),this._userService.getAllUsers(),this._initializeGrid(),this._userService.users$.pipe(w(this._destroyRef)).subscribe(e=>{this.refresh$.next({data:e})})}_initializeGrid(){this.gridConfig={data:g([]),defaultPagination:100,maxTableHeight:R.maxTableHeightWithSearch,noDataMessage:{text:"No Users Found"},elevation:8,features:{showSearch:!0},columns:[{field:"online",title:"Online",type:"chip",extraStyles:{"min-width":"100px"},position:"p-start",truthy:{false:"No",true:"Yes"},setChipClass:e=>e.online===!0?"rounded rounded-5 px-3 py-1 text-bg-success cs-w-120":"rounded rounded-5 px-3 py-1 text-bg-danger cs-w-120"},{field:"email",title:"email",type:"string",position:"p-start",extraStyles:{"min-width":"100px"}},{field:"name",title:"Name",type:"string",position:"p-start",extraStyles:{"min-width":"120px"}},{field:"roleNames",title:"Roles",type:"string",extraStyles:{"min-width":"180px"}},{field:"twoFactorEnabled",title:"2FA",type:"chip",extraStyles:{"min-width":"100px"},position:"p-start",truthy:{false:"No",true:"Yes"},setChipClass:e=>e.twoFactorEnabled===!0?"rounded rounded-5 px-3 py-1 text-bg-success cs-w-120":"rounded rounded-5 px-3 py-1 text-bg-danger cs-w-120"},{field:"passwordRetries",title:"Retries",type:"number",extraStyles:{"min-width":"100px"}},{field:"active",title:"Active",type:"chip",extraStyles:{"min-width":"100px"},position:"p-start",truthy:{false:"No",true:"Yes"},setChipClass:e=>e.active===!0?"rounded rounded-5 px-3 py-1 text-bg-success cs-w-120":"rounded rounded-5 px-3 py-1 text-bg-danger cs-w-120"},{field:"suspended",title:"Suspended",type:"chip",extraStyles:{"min-width":"100px"},position:"p-start",truthy:{false:"No",true:"Yes"},setChipClass:e=>e.suspended===!0?"rounded rounded-5 px-3 py-1 text-bg-success cs-w-120":"rounded rounded-5 px-3 py-1 text-bg-danger cs-w-120"},{field:"createdAt",title:"Created At",type:"date",dateFormat:"dd/MM/yyyy - HH:mm:ss a",extraStyles:{"min-width":"180px"}}],actionsColumn:{enabled:this._currentScreen.update||this._currentScreen.delete,maxButtons:1,maxWidth:"50px",minWidth:"50px",buttons:[{prefixIcon:{icon:"icon_message"},label:{text:"Send Message"},onClickFn:e=>this._sendMessage(e),isVisibleFn:e=>!!e.online,matType:"mat-icon-button"},{prefixIcon:{icon:"icon_logout"},label:{text:"Force Logout"},onClickFn:e=>this._forceLogout(e),isVisibleFn:e=>this._currentScreen.update&&!!e.online,matType:"mat-icon-button"},{prefixIcon:{icon:"icon_block"},label:{text:"Suspend"},onClickFn:e=>this._toggleSuspension(e),isVisibleFn:e=>this._currentScreen.update&&!e.suspended,matType:"mat-icon-button"},{prefixIcon:{icon:"icon_check_circle"},label:{text:"Unsuspend"},onClickFn:e=>this._toggleSuspension(e),isVisibleFn:e=>this._currentScreen.update&&!!e.suspended,matType:"mat-icon-button"},{prefixIcon:{icon:"icon_reset_password"},label:{text:"Change Password"},onClickFn:e=>this._changePassword(e),isVisibleFn:()=>this._currentScreen.update,matType:"mat-icon-button"},{prefixIcon:{icon:"icon_check_double"},label:{text:"Activate User"},onClickFn:e=>this._activateUser(e),isVisibleFn:e=>this._currentScreen.update&&(!e.active||e.passwordRetries>=10),matType:"mat-icon-button"},{prefixIcon:{icon:"icon_unlock"},label:{text:"Remove 2Fa"},onClickFn:e=>this._removeUser2Fa(e),isVisibleFn:e=>this._currentScreen.update&&!!e.twoFactorEnabled,matType:"mat-icon-button"},{prefixIcon:{icon:"icon_edit"},label:{text:"Edit"},onClickFn:e=>this._openUserPopup(e),isVisibleFn:()=>this._currentScreen.update,matType:"mat-icon-button"},{prefixIcon:{icon:"icon_delete",color:"red"},label:{text:"Delete"},onClickFn:e=>this._deleteUser(e),isVisibleFn:()=>this._currentScreen.delete,matType:"mat-icon-button"}]}}}_openUserPopup(e){let t={title:{text:e?"Edit user":"Add User"},hideClearButton:!0,form:{value:e,fields:[{type:"text",name:"email",label:{text:"Email"},required:!0,maxLength:50,readonly:!!e,extraValidators:[k],preventSpace:!0},{type:"text",name:"name",label:{text:"Name"},required:!0,minLength:4,maxLength:30},{type:"select",name:"roles",multiple:!0,label:{text:"Roles"},required:!0,stream:this._lovService.rolesLov$,transformer:{nameKey:"name",valueKey:"value"}},{type:"password",name:"password",label:{text:"Password"},minLength:4,required:!e,hide:!!e},{type:"toggle",name:"_sendEmail",label:{text:"Send Welcome Email"},hide:!!e}],formatFormValue:!0},beforeCloseObservable:i=>e?this._userService.editUser(a(a({},e),i)):this._userService.addNewUser(i),getAfterSuccessResponse:()=>{this._userService.getAllUsers()}};this._dialog.openFormPopup(t,"500px")}_toggleSuspension(e){let t={title:{text:e.suspended?"Unsuspend User":"Suspend User"},hideClearButton:!0,form:{value:e,fields:[{name:"sendEmail",label:{text:"Send Email"},type:"checkbox"}]},beforeCloseObservable:i=>this._userService.toggleUserSuspension(e,i.sendEmail),getAfterSuccessResponse:()=>{this._userService.getAllUsers()}};this._dialog.openFormPopup(t,"500px")}_deleteUser(e){let t={title:{text:"Confirm Delete"},message:{text:"Are you certain you want to delete this user?"}};this._dialog.openConfirmPopup(t).afterClosed().pipe(o(1)).subscribe(i=>{i&&e?._id&&this._userService.deleteUser(e)})}_activateUser(e){let t={title:{text:"Confirm Activation"},message:{text:"Are you certain you want to activate this user?"}};this._dialog.openConfirmPopup(t).afterClosed().pipe(o(1)).subscribe(i=>{i&&e?._id&&this._userService.activateUser(e)})}_removeUser2Fa(e){let t={title:{text:"Confirm 2Fa Removal"},message:{text:"Are you certain you want to remove 2Fa for this user?"}};this._dialog.openConfirmPopup(t).afterClosed().pipe(o(1)).subscribe(i=>{i&&e?._id&&this._userService.remove2FaForUser(e)})}_changePassword(e){let t={title:{text:"Change Password"},saveButton:{label:{text:"Send"},prefixIcon:{icon:"icon_play"},matType:"mat-flat-button"},hideClearButton:!0,form:{fields:[{name:"password",label:{text:"new Password"},type:"password",required:!0,minLength:4}]},beforeCloseObservable:i=>this._userService.changeUserPassword(a(a({},e),i))};this._dialog.openFormPopup(t,"500px")}_sendMessage(e){let t={title:{text:"Send message"},saveButton:{label:{text:"Send"},prefixIcon:{icon:"icon_play"},matType:"mat-flat-button"},hideClearButton:!0,form:{value:{title:"Message",user:e.name},fields:[{name:"user",type:"text",label:{text:"User"},readonly:!0},{name:"title",type:"text",label:{text:"Dialog Title"},maxLength:50},{name:"message",label:{text:"Message"},type:"text",required:!0}]},beforeCloseObservable:i=>this._userService.sendMessageToUserUser(e,c(a({},i),{isDialog:!0}))};this._dialog.openFormPopup(t,"500px")}_forceLogout(e){let t={title:{text:"Confirm Logout"},message:{text:"Are you certain you want to force logout this user?"}};this._dialog.openConfirmPopup(t).afterClosed().pipe(o(1)).subscribe(i=>{i&&e?._id&&this._userService.forceLogoutUser(e)})}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275cmp=h({type:s,selectors:[["ks-solutions-users-listing"]],standalone:!0,features:[y([p]),C],decls:1,vars:1,consts:[[3,"config","refresh$"]],template:function(t,i){t&1&&x(0,L,1,2,"ks-basic-grid",0),t&2&&S(i.gridConfig?0:-1)},dependencies:[P],changeDetection:0})}}return s})();export{ie as UsersComponent};
